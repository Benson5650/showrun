<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seating Chart</title>
    <style>
        /* 載入動畫 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes success {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            background-color: transparent;
        }
        
        .loader-text {
            color: white;
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease;
        }
        
        .bounce {
            animation: bounce 1s ease;
        }
        
        .success-animation {
            color: #28a745;
            font-size: 24px;
            animation: success 0.5s ease;
        }
        
        .error-animation {
            color: #dc3545;
            font-size: 24px;
            animation: success 0.5s ease;
        }
        
        .google-btn {
            display: inline-flex;
            align-items: center;
            background-color: #4285F4;
            border-radius: 2px;
            box-shadow: 0 3px 4px 0 rgba(0,0,0,.25);
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 0;
            border: none;
        }
        
        .google-btn:hover {
            box-shadow: 0 0 6px #4285F4;
        }
        
        .google-btn:active {
            background-color: #1669F2;
        }
        
        .google-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 2px 0 0 2px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .google-icon {
            width: 18px;
            height: 18px;
        }
        
        .btn-text {
            color: white;
            font-size: 14px;
            letter-spacing: 0.2px;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            padding: 0 16px;
        }
        
        /* 原有的樣式 */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 20px;
            background-color: #fafafa;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }
        h1, h2 {
            color: #333;
            margin-bottom: 0.5em;
            text-align: center;
        }
        h1 {
            margin-top: 0;
        }
        label {
            font-weight: bold;
        }
        select, input[type="number"], input[type="text"] {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }
        select:focus, input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 5px rgba(40,167,69,0.2);
        }
        button {
            padding: 10px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 4px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover {
            background-color: #218838;
        }
        table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 80%;
            background-color: #fff;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        td {
            border: 1px solid #ddd;
            padding: 25px;
            font-size: 1.2rem;
            text-align: center;
            font-size: 1rem;
            position: relative;
            cursor: pointer;
        }
        td:hover {
            background-color: #f0f0f0;
        }
        td.highlight:hover {
            background-color:rgb(252, 245, 116);
        }
        td.chosen:hover {
            background-color:rgb(138, 236, 192);
        }
        .highlight {
            background-color: #fffa90;
        }
        .chosen {
            background-color: #aaf0d1;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .container {
            max-width: 33%;
            margin: 0 auto;
        }
        #methods, #method-details {
            margin: 20px 0;
            background-color: #fff;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #method-select {
            font-size: 1rem;
        }
        hr {
            margin: 30px 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .user-section {
            text-align: right;
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        .user-section button {
            margin-left: 10px;
        }
        .save-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .save-section input {
            width: calc(100% - 120px);
            margin-right: 10px;
        }
        #saved-items {
            margin-top: 20px;
        }
        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .saved-item button {
            margin-left: 10px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <!-- 載入動畫覆蓋層 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-container">
            <div class="loader"></div>
            <div class="loader-text" id="loading-text">載入中...</div>
        </div>
    </div>

    <!-- 使用者區域 -->
    <div class="user-section">
        {% if current_user.is_authenticated %}
            <span class="fade-in">歡迎, {{ current_user.name }}</span>
            <button onclick="handleLogout()" class="fade-in">登出</button>
        {% else %}
            <button onclick="handleLogin()" class="google-btn">
                <div class="google-icon-wrapper">
                    <img class="google-icon" src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google Logo"/>
                </div>
                <span class="btn-text">使用 Google 登入</span>
            </button>
        {% endif %}
    </div>

    <!-- 原有的警示框 -->
    <div id="custom-alert" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p>你被選到了!!!</p>
        </div>
    </div>

    <h1>高中牲選號機</h1>

    {% if current_user.is_authenticated %}
        <!-- 儲存區域 -->
        <div class="save-section">
            <h3>儲存座位表</h3>
            <div>
                <input type="text" id="save-name" placeholder="輸入名稱">
                <button onclick="saveSeatingChart()">儲存</button>
            </div>
            <div id="saved-seating-charts"></div>
        </div>

        <div class="save-section">
            <h3>儲存方法</h3>
            <div>
                <input type="text" id="save-method-name" placeholder="輸入名稱">
                <button onclick="saveCurrentMethod()">儲存</button>
            </div>
            <div id="saved-methods"></div>
        </div>
    {% endif %}

    <div id="custom-alert" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p>你被選到了!!!</p>
        </div>
    </div>
    
    <div class="form-group" id="method-selection">
        <label for="method-select">選擇方法:</label>
            <select id="method-select" class="sc-input">
                <option value="小十字">小十字</option>
                <option value="大十字">大十字</option>
                <option value="小叉叉">小叉叉</option>
                <option value="大叉叉">大叉叉</option>
                <option value="九宮格">九宮格</option>
                <option value="Σ">Σ</option>
                <option value="麥當勞">麥當勞</option>
                <option value="積分">積分</option>
                <option value="微分">微分</option>
                <option value="肯德基">肯德基</option>
                <option value="橫排">橫排</option>
                <option value="直列">直列</option>
                <option value="π">π</option>
                <option value="otamatone">otamatone</option>
            </select>   
    </div>

    <div id="seating-chart"></div>

    <div class="form-group">
        <div class="input-container">
            <input type="number" id="user-number" placeholder="請輸入你的座號">
            <input type="number" id="seat-number" placeholder="請輸入中籤座號或點擊座位表" onkeydown="if(event.key === 'Enter') applySelectedMethod()">
            <button onclick="applySelectedMethod()">確認</button>
        </div>
    </div>
    <hr>
    <h2>新增方法</h2>
    <div class="form-group">
        <div class="input-container">
            <label><input type="checkbox" id="wrap-around"> 穿牆
            <input type="text" id="method-name" placeholder="請輸入方法名稱" >
            <input type="text" id="directions" placeholder="請輸入方向 (例如: [1,0],[-1,0])" onkeydown="if(event.key === 'Enter') addNewMethod()" >
            </label>
        </div>
        <button onclick="addNewMethod()">新增方法</button>
    </div>
    <hr>
    <h2>更改座位表</h2>
    <div class="form-group">
        <div class="input-container">
            <input type="number" id="rows" placeholder="請輸入列數" min="1" style="width: 48%;">
            <input type="number" id="cols" placeholder="請輸入行數" min="1" style="width: 48%;">
            <button onclick="toggleEditMode()" id="edit-mode-btn" style="margin-top: 10px; width: 100%;">進入編輯模式</button>
        </div>
        <div class="input-container" style="margin-top: 10px;">
            <button onclick="createEmptyChart()">建立空白座位表</button>
            <button onclick="clearSeatingChart()">清空座位表</button>
        </div>
        <div class="input-container" style="margin-top: 10px;">
            <input type="text" id="new-seatingchart" placeholder="請輸入座位表(以空格區隔座位，逗號換行)">
        </div>
        <button onclick="updateSeatingChart()">更新座位表</button>
        <button onclick="exportSeatingChart()">匯出座位表</button>

    <script>
        let seatingChart = [
            [19, 27, 11, 17, 23],
            [30, 9, 1, 29, 6],
            [3, 4, 21, 25, 22],
            [24, 14, 18, 15, 10],
            [7, 5, 20, 28, 2],
            [26, 8, 16, 12, 13]
        ];

        const methods = {
            "小十字": {
                "wrap_around": true,
                "directions": [[1, 0], [-1, 0], [0, 1], [0, -1]]
            },
            "大十字": {
                "wrap_around": false,
                "directions": [[1, 0], [2, 0], [3, 0], [4, 0], [5, 0], [-1, 0], [-2, 0], [-3, 0], [-4, 0], [-5, 0], [0, 1], [0, 2], [0, 3], [0, 4], [0, 5], [0, -1], [0, -2], [0, -3], [0, -4], [0, -5]]
            },
            "大叉叉": {
                "wrap_around": false,
                "directions": [[1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [-1, -1], [-2, -2], [-3, -3], [-4, -4], [-5, -5], [1, -1], [2, -2], [3, -3], [4, -4], [5, -5], [-1, 1], [-2, 2], [-3, 3], [-4, 4], [-5, 5]]
            },
            "小叉叉": {
                "wrap_around": true,
                "directions": [[1, 1], [-1, -1], [1, -1], [-1, 1]]
            },
            "九宮格": {
                "wrap_around": true,
                "directions": [[1, 0], [1, 1], [0, 1], [-1, 1], [-1, 0], [-1, -1], [0, -1], [1, -1]]
            },
            "Σ": {
                "wrap_around": true,
                "directions": [[-1, 1], [-2, 2], [-1, 2], [0, 2], [1, 2],[-1, -1], [-2, -2], [-1, -2], [0, -2], [1, -2]]
            },
            "麥當勞": {
                "wrap_around": true,
                "directions": [[1, 1], [2, 2], [2, 1], [2, 0], [2, -1], [-1, 1], [-2, 2], [-2, 1], [-2, 0], [-2, -1]]
            },
            "積分": {
                "wrap_around": true,
                "directions": [[0,1],[0,2],[1,2],[0,-1],[0,-2],[-1,-2]]
            },
            "微分": {
                "wrap_around": true,
                "directions":[[1,1],[2,2]]
            },
            "肯德基": {
                "wrap_around": true,
                "directions": [[0,1],[0,2],[0,-1],[0,-2],[1,1],[2,2],[1,-1],[2,-2]]
            },
            "橫排": {
                "wrap_around": false,
                "directions": [[1, 0], [2, 0], [3, 0], [4, 0], [5, 0], [-1, 0], [-2, 0], [-3, 0], [-4, 0], [-5, 0]]
            },
            "直列": {
                "wrap_around": false,
                "directions": [[0, 1], [0, 2], [0, 3], [0, 4], [0, 5], [0, -1], [0, -2], [0, -3], [0, -4], [0, -5]]
            },
            "π": {
                "wrap_around": true,
                "directions": [[1, 0], [2, 0], [-1, 0], [-2, 0],[1,-1],[1,-2],[1,-3],[2,-3],[-1,-1],[-1,-2],[-1,-3]]
            },
            "otamatone": {
                "wrap_around": true,
                "directions": [[1, 0], [-1, 0], [0, 1], [0, -1],[0,2],[0,3],[1,3]]
            }
        };

        let isEditMode = false;

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            btn.textContent = isEditMode ? '退出編輯模式' : '進入編輯模式';
            btn.style.backgroundColor = isEditMode ? '#dc3545' : '#28a745';
            printSeatingChart(seatingChart);
        }

        function printSeatingChart(seatingChart) {
            const container = document.getElementById('seating-chart');
            container.innerHTML = '';
            const table = document.createElement('table');
            seatingChart.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((num, colIndex) => {
                    const td = document.createElement('td');
                    td.contentEditable = isEditMode;
                    td.textContent = num;
                    
                    if (isEditMode) {
                        const selectAllText = () => {
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(td);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        };

                        td.addEventListener('click', selectAllText);
                        td.addEventListener('focus', selectAllText);

                        td.addEventListener('input', () => {
                            const value = td.textContent.replace(/\D/g, '');
                            if (value) {
                                td.textContent = value;
                            }
                        });

                        td.addEventListener('blur', () => {
                            const newValue = parseInt(td.textContent);
                            if (!isNaN(newValue)) {
                                seatingChart[rowIndex][colIndex] = newValue;
                            } else {
                                td.textContent = num;
                            }
                        });
                    } else {
                        td.addEventListener('click', () => {
                            document.getElementById('seat-number').value = num;
                            applySelectedMethod();
                        });
                    }

                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
            container.appendChild(table);
        }

        function createEmptyChart() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            
            if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) {
                showModal('請輸入有效的列數和行數');
                return;
            }

            seatingChart = Array.from({ length: rows }, () => 
                Array.from({ length: cols }, () => 0)
            );
            printSeatingChart(seatingChart);
            showModal('已建立空白座位表，請編輯座位號碼');
        }

        function clearSeatingChart() {
            if (seatingChart.length > 0) {
                const rows = seatingChart.length;
                const cols = seatingChart[0].length;
                seatingChart = Array.from({ length: rows }, () => 
                    Array.from({ length: cols }, () => 0)
                );
                printSeatingChart(seatingChart);
                showModal('座位表已清空');
            }
        }

        function exportSeatingChart() {
            const exportText = seatingChart
                .map(row => row.join(' '))
                .join(',');
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'seating_chart.txt';
            
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function updateSeatingChart() {
            const newSeatingChart = document.getElementById('new-seatingchart').value;
            const newSeatingChartArray = newSeatingChart.split(',').map(row => row.trim().split(' ').map(Number));
            
            if (newSeatingChartArray.every(row => row.every(num => !isNaN(num)))) {
                const flatArray = newSeatingChartArray.flat();
                const uniqueNumbers = new Set(flatArray);
                
                if (flatArray.length !== uniqueNumbers.size) {
                    showModal('座號重複，請檢查輸入的座位表');
                    return;
                }
                
                seatingChart = newSeatingChartArray;
                printSeatingChart(seatingChart);
                showModal('座位表已更新');
                document.getElementById('new-seatingchart').value = '';
            } else {
                showModal('請輸入正確的座位表');
            }
        }

        function getPosition(seatingChart, r, c, wrapAround) {
            const rows = seatingChart.length;
            const cols = seatingChart[0].length;
            if (wrapAround) {
                r = (r + rows) % rows;
                c = (c + cols) % cols;
                return seatingChart[r][c];
            } else {
                if (0 <= r && r < rows && 0 <= c && c < cols) {
                    return seatingChart[r][c];
                } else {
                    return null;
                }
            }
        }

        function applyMethod(seatingChart, number, methodName, methods) {
            const [row, col] = findNumber(seatingChart, number) || [];
            if (row === undefined || col === undefined) {
                return [];  
            }

            const method = methods[methodName];
            if (!method) {
                return [];  
            }

            const wrapAround = method.wrap_around;
            const directions = method.directions;

            if (!Array.isArray(directions) || !directions.every(d => Array.isArray(d) && d.length === 2)) {
                return []; 
            }

            const values = new Set();
            directions.forEach(direction => {
                const r = row - direction[1];
                const c = col + direction[0];
                const value = getPosition(seatingChart, r, c, wrapAround);
                if (value !== null) {
                    values.add(value);
                }
            });

            return Array.from(values).sort((a, b) => a - b);  
        }

        function visualizeResult(seatingChart, result, seatNumber) {
            const container = document.getElementById('seating-chart');
            const table = container.querySelector('table');
            
            seatingChart.forEach((row, rowIndex) => {
                row.forEach((num, colIndex) => {
                    const cell = table.rows[rowIndex].cells[colIndex];
                    cell.classList.remove('highlight', 'chosen');
                });
            });

            seatingChart.forEach((row, rowIndex) => {
                row.forEach((num, colIndex) => {
                    const cell = table.rows[rowIndex].cells[colIndex];
                    if (num === seatNumber) {
                        cell.classList.add('chosen');
                    } else if (result.includes(num)) {
                        cell.classList.add('highlight');
                    }
                });
            });
        }

        function findNumber(seatingChart, number) {
            for (let row = 0; row < seatingChart.length; row++) {
                for (let col = 0; col < seatingChart[row].length; col++) {
                    if (seatingChart[row][col] === number) {
                        return [row, col];
                    }
                }
            }
            return null;
        }

        function applySelectedMethod() {
            const seatNumber = parseInt(document.getElementById('seat-number').value);
            const userNumber = parseInt(document.getElementById('user-number').value);
            const methodName = document.getElementById('method-select').value; 
            const result = applyMethod(seatingChart, seatNumber, methodName, methods);
            visualizeResult(seatingChart, result, seatNumber);
            document.getElementById('seat-number').value = '';
            if (result.includes(userNumber)) {
                showModal("你被選中了!!!");
            }
        }

        function addNewMethod() {
            const methodName = document.getElementById('method-name').value;
            const wrapAround = document.getElementById('wrap-around').checked;
            const directionsInput = document.getElementById('directions').value;
            const directions = directionsInput.split('],[').map(d => d.replace('[', '').replace(']', '').split(',').map(Number));

            if (methodName && Array.isArray(directions) && directions.every(d => Array.isArray(d) && d.length === 2)) {
                methods[methodName] = {
                    wrap_around: wrapAround,
                    directions: directions
                };
            
                updateMethodSelect();
                showModal('新方法已添加');
                document.getElementById('method-name').value = '';
                document.getElementById('wrap-around').checked = false;
                document.getElementById('directions').value = '';
            } else {
                showModal('請輸入有效的方法名稱和方向');
            }
        }

        function updateMethodSelect() {
            const methodSelect = document.getElementById('method-select');
            methodSelect.innerHTML = '';
            Object.keys(methods).forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                methodSelect.appendChild(option);
            });
        }

        function showModal(message) {
            const modal = document.getElementById('custom-alert');
            modal.querySelector('p').textContent = message;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            const modal = document.getElementById('custom-alert');
            modal.style.display = 'none';
        }
        // Google API 相關動畫功能
        function showLoading(message = '載入中...') {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.animation = 'fadeOut 0.3s ease-in-out';
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.animation = 'fadeIn 0.3s ease-in-out';
            }, 300);
        }
        
        function handleLogin() {
            showLoading('Google 登入中...');
            window.location.href = '/login';
        }
        
        function handleLogout() {
            showLoading('登出中...');
            window.location.href = '/logout';
        }
        
        {% if current_user.is_authenticated %}
            
            function showSuccessAnimation(container, message) {
                const successElement = document.createElement('div');
                successElement.className = 'success-animation';
                successElement.innerHTML = `<i>✓</i> ${message}`;
                container.appendChild(successElement);
                
                setTimeout(() => {
                    successElement.remove();
                }, 2000);
            }
            
            function showErrorAnimation(container, message) {
                const errorElement = document.createElement('div');
                errorElement.className = 'error-animation';
                errorElement.innerHTML = `<i>✗</i> ${message}`;
                container.appendChild(errorElement);
                
                setTimeout(() => {
                    errorElement.remove();
                }, 2000);
            }

            async function saveSeatingChart() {
                const name = document.getElementById('save-name').value;
                if (!name) {
                    showModal('請輸入座位表名稱');
                    return;
                }
                
                const container = document.getElementById('saved-seating-charts');
                showLoading('儲存座位表中...');

                try {
                    const response = await fetch('/api/seating-charts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            data: seatingChart
                        })
                    });

                    hideLoading();
                    if (response.ok) {
                        document.getElementById('save-name').value = '';
                        loadSavedSeatingCharts();
                        showSuccessAnimation(container, '座位表已儲存');
                    } else {
                        showErrorAnimation(container, '儲存失敗');
                    }
                } catch (error) {
                    hideLoading();
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            async function loadSavedSeatingCharts() {
                showLoading('載入座位表清單...');
                try {
                    const response = await fetch('/api/seating-charts');
                    const container = document.getElementById('saved-seating-charts');
                    
                    hideLoading();
                    if (response.ok) {
                        const charts = await response.json();
                        container.innerHTML = '<h4>已儲存的座位表：</h4>';
                        
                        charts.forEach((chart, index) => {
                            const div = document.createElement('div');
                            div.className = 'saved-item fade-in';
                            div.style.animationDelay = `${index * 0.1}s`;
                            div.innerHTML = `
                                <span>${chart.name}</span>
                                <div>
                                    <button onclick='loadSeatingChart(${JSON.stringify(chart.data)}, ${chart.id})'>載入</button>
                                    <button onclick='deleteSeatingChart(${chart.id})' style="background-color: #dc3545;">刪除</button>
                                </div>
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        showErrorAnimation(container, '載入失敗');
                    }
                } catch (error) {
                    hideLoading();
                    const container = document.getElementById('saved-seating-charts');
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            async function saveCurrentMethod() {
                const name = document.getElementById('save-method-name').value;
                const methodName = document.getElementById('method-select').value;
                if (!name) {
                    showModal('請輸入方法名稱');
                    return;
                }

                const container = document.getElementById('saved-methods');
                showLoading('儲存方法中...');

                try {
                    const response = await fetch('/api/methods', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            data: methods[methodName]
                        })
                    });

                    hideLoading();
                    if (response.ok) {
                        document.getElementById('save-method-name').value = '';
                        loadSavedMethods();
                        showSuccessAnimation(container, '方法已儲存');
                    } else {
                        showErrorAnimation(container, '儲存失敗');
                    }
                } catch (error) {
                    hideLoading();
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            async function loadSavedMethods() {
                showLoading('載入方法清單...');
                
                try {
                    const response = await fetch('/api/methods');
                    const container = document.getElementById('saved-methods');
                    
                    hideLoading();
                    if (response.ok) {
                        const savedMethods = await response.json();
                        container.innerHTML = '<h4>已儲存的方法：</h4>';
                        
                        savedMethods.forEach((method, index) => {
                            const div = document.createElement('div');
                            div.className = 'saved-item fade-in';
                            div.style.animationDelay = `${index * 0.1}s`;
                            div.innerHTML = `
                                <span>${method.name}</span>
                                <div>
                                    <button onclick='loadMethod("${method.name}", ${JSON.stringify(method.data)})'>載入</button>
                                    <button onclick='deleteMethod(${method.id})' style="background-color: #dc3545;">刪除</button>
                                </div>
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        showErrorAnimation(container, '載入失敗');
                    }
                } catch (error) {
                    hideLoading();
                    const container = document.getElementById('saved-methods');
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            function loadSeatingChart(chartData, chartId) {
                showLoading('載入座位表...');
                
                setTimeout(() => {
                    seatingChart = chartData;
                    printSeatingChart(seatingChart);
                    hideLoading();
                    
                    const table = document.querySelector('#seating-chart table');
                    if (table) {
                        table.classList.add('bounce');
                        setTimeout(() => {
                            table.classList.remove('bounce');
                        }, 1000);
                    }
                    
                    showModal('座位表已載入');
                }, 500);
            }

            function loadMethod(name, methodData) {
                showLoading('載入方法...');
                
                setTimeout(() => {
                    methods[name] = methodData;
                    updateMethodSelect();
                    document.getElementById('method-select').value = name;
                    hideLoading();
                    
                    const select = document.getElementById('method-select');
                    select.classList.add('bounce');
                    setTimeout(() => {
                        select.classList.remove('bounce');
                    }, 1000);
                    
                    showModal('方法已載入');
                }, 500);
            }

            // 新增刪除功能
            async function deleteSeatingChart(id) {
                if (!confirm('確定要刪除這個座位表嗎？')) {
                    return;
                }

                showLoading('刪除座位表中...');
                
                try {
                    const response = await fetch(`/api/seating-charts/${id}`, {
                        method: 'DELETE'
                    });

                    hideLoading();
                    const container = document.getElementById('saved-seating-charts');
                    
                    if (response.ok) {
                        showSuccessAnimation(container, '座位表已刪除');
                        loadSavedSeatingCharts();
                    } else {
                        showErrorAnimation(container, '刪除失敗');
                    }
                } catch (error) {
                    hideLoading();
                    const container = document.getElementById('saved-seating-charts');
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            async function deleteMethod(id) {
                if (!confirm('確定要刪除這個方法嗎？')) {
                    return;
                }

                showLoading('刪除方法中...');
                
                try {
                    const response = await fetch(`/api/methods/${id}`, {
                        method: 'DELETE'
                    });

                    hideLoading();
                    const container = document.getElementById('saved-methods');
                    
                    if (response.ok) {
                        showSuccessAnimation(container, '方法已刪除');
                        loadSavedMethods();
                    } else {
                        showErrorAnimation(container, '刪除失敗');
                    }
                } catch (error) {
                    hideLoading();
                    const container = document.getElementById('saved-methods');
                    showErrorAnimation(container, '發生錯誤');
                }
            }

            // 初始載入預設座位表和已儲存的資料
            window.addEventListener('load', () => {
                // 無論是否登入，都先顯示預設座位表
                printSeatingChart(seatingChart);
                
                // 如果已登入，再載入儲存的資料
                if ({{ current_user.is_authenticated|tojson }}) {
                    setTimeout(() => {
                        loadSavedSeatingCharts();
                        loadSavedMethods();
                    }, 500);
                }
            });
        {% else %}
            // 未登入用戶的初始化載入
            window.addEventListener('load', () => {
                // 顯示預設座位表
                printSeatingChart(seatingChart);
            });
        {% endif %}
    </script>
</body>
</html>
